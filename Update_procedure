/*
	This is a procedure in mysql which updates Account table based on certain conditions.
	It takes amount, year and city as the input parameters and updates the Account table.
	Corresponding expected exceptions are also handled in the procedure.
	Code will stop immediately after the exception is raised.
*/




DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `usp_GIVE_BONOUS`(
	in city varchar(40),
    in year int,
    amount int
    )
BEGIN
        
	DECLARE HUGE_AMOUNT CONDITION FOR sqlstate 'HY000';
	DECLARE INCORRECT_CITY CONDITION FOR sqlstate '42000';
    DECLARE INCORRECT_YEAR CONDITION FOR sqlstate '01000';
    
	DECLARE EXIT HANDLER FOR HUGE_AMOUNT
	RESIGNAL SET MESSAGE_TEXT = 'The given Amount is HUGE!!!';
    
    DECLARE EXIT HANDLER FOR INCORRECT_CITY
	RESIGNAL SET MESSAGE_TEXT = 'The given CITY is WRONG!!!';
    
    DECLARE EXIT HANDLER FOR INCORRECT_YEAR
	RESIGNAL SET MESSAGE_TEXT = 'The given YEAR is WRONG!!!';
	
	IF AMOUNT > 100000 THEN
        SIGNAL HUGE_AMOUNT;
    ELSEIF CEIL(CITY) != 0 THEN
        SIGNAL INCORRECT_CITY;
    ELSEIF CAST(YEAR AS unsigned) = 0 OR YEAR > 100 THEN
        SIGNAL INCORRECT_YEAR;
    END IF;
    

	UPDATE ACCOUNT A 
		SET A.OPENING_BALANCE = A.OPENING_BALANCE + AMOUNT
        WHERE 
        TIMESTAMPDIFF(MONTH, A.AOD, CURDATE()) > YEAR * 12
        AND 
        A.ASTATUS = 'Active'
        AND 
        A.CUSTID IN (SELECT CUSTID FROM CUSTOMER C WHERE C.CITY = city);
END$$
DELIMITER ;
